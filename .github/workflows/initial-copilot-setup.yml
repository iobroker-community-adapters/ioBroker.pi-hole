# GitHub Action Template: Initial ioBroker Copilot Setup
# Version: 0.4.0
#
# This action handles the initial setup of GitHub Copilot instructions for ioBroker adapters

name: Initial ioBroker Copilot Setup

on:
  workflow_dispatch:  # Manual triggering for initial setup
    inputs:
      force_setup:
        description: 'Force setup even if copilot-instructions.md already exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  initial-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check repository structure
        id: repo-check
        run: |
          echo "üîç Analyzing repository structure..."

          # Check if this is an ioBroker adapter
          IOBROKER_ADAPTER="false"
          if [ -f "package.json" ] && grep -q "iobroker" package.json; then
            IOBROKER_ADAPTER="true"
          elif [ -f "io-package.json" ]; then
            IOBROKER_ADAPTER="true"
          fi

          echo "is_iobroker_adapter=$IOBROKER_ADAPTER" >> $GITHUB_OUTPUT

          # Check if copilot instructions already exist
          COPILOT_EXISTS="false"
          if [ -f ".github/copilot-instructions.md" ]; then
            COPILOT_EXISTS="true"
          fi

          echo "copilot_exists=$COPILOT_EXISTS" >> $GITHUB_OUTPUT

          # Extract adapter information
          if [ -f "package.json" ]; then
            ADAPTER_NAME=$(jq -r '.name // "unknown"' package.json)
            DESCRIPTION=$(jq -r '.description // "ioBroker adapter"' package.json)
          else
            ADAPTER_NAME="unknown"
            DESCRIPTION="ioBroker adapter"
          fi

          echo "adapter_name=$ADAPTER_NAME" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Get latest template version
        id: version-check
        run: |
          echo "üåê Fetching latest template version..."
          LATEST_VERSION=$(curl -s https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/config/metadata.json | jq -r '.version' 2>/dev/null)
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "‚ö†Ô∏è  Could not fetch latest version from metadata.json"
            LATEST_VERSION="unknown"
          fi
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "üìã Latest version: $LATEST_VERSION"

      - name: Create initial copilot instructions
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        run: |
          echo "üìù Creating initial copilot instructions..."

          # Create .github directory if it doesn't exist
          mkdir -p .github

          # Download and process the full template
          curl -s https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md \
            | sed '/^<!--$/,/^-->$/d' \
            > .github/copilot-instructions.md

          echo "‚úÖ Copilot instructions created from latest template"

      - name: Commit initial setup
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/copilot-instructions.md
          git commit -m "feat: initialize ioBroker Copilot instructions with adapter context" || echo "No changes to commit"
          git push

      - name: Create follow-up issue for enhancement
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true' && (steps.repo-check.outputs.copilot_exists == 'false' || github.event.inputs.force_setup == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ü§ñ Enhance ioBroker Copilot Instructions';
            const body = `# Automated ioBroker Copilot Template Enhancement

            Initial copilot instructions have been created with basic adapter context.
            Now enhance them with the full template for comprehensive development support.

            **GitHub Copilot**: Please help me enhance my ioBroker adapter's Copilot instructions by merging with the latest template while preserving the existing adapter-specific context.

            ## Enhancement Process

            1. **Fetch Full Template**: https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/template.md
            2. **Preserve Existing Context**: Keep all adapter-specific information already in place
            3. **Merge Content**: Add comprehensive ioBroker development patterns and best practices
            4. **Customize Sections**: Populate [CUSTOMIZE] sections with adapter-specific content only

            ## Expected Outcome

            Enhanced .github/copilot-instructions.md with:
            - ‚úÖ Preserved adapter-specific context
            - ‚úÖ Full ioBroker development patterns
            - ‚úÖ Comprehensive testing guidelines
            - ‚úÖ Error handling best practices
            - ‚úÖ CI/CD integration guidance
            - ‚úÖ JSON-Config management

            **Template Version**: ${{ steps.version-check.outputs.latest_version }}
            **Adapter**: ${{ steps.repo-check.outputs.adapter_name }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['copilot-setup', 'automation', 'enhancement']
            });

      - name: Setup automated version checking
        if: steps.repo-check.outputs.is_iobroker_adapter == 'true'
        run: |
          echo "‚öôÔ∏è Setting up automated version checking workflow..."

          # Create workflows directory if it doesn't exist
          mkdir -p .github/workflows

          # Download and create the automated version check workflow if not present
          if [ ! -f ".github/workflows/check-copilot-template.yml" ]; then
            curl -o .github/workflows/check-copilot-template.yml \
              https://raw.githubusercontent.com/DrozmotiX/ioBroker-Copilot-Instructions/main/templates/ghAction-AutomatedVersionCheckAndUpdate.yml

            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .github/workflows/check-copilot-template.yml
            git commit -m "feat: add automated copilot template version checking" || echo "No changes to commit"
            git push
          else
            echo "‚úÖ check-copilot-template.yml already exists, skipping"
          fi
